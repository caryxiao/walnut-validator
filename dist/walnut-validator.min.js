/*!
 * walnut-validator.js v1.0.0
 * (c) 2016 Cary Xiao
 * Released under the MIT License.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("jquery")):"function"==typeof define&&define.amd?define(["jquery"],t):e.WalnutValidator=t(e.jQuery)}(this,function(e){"use strict";e="default"in e?e["default"]:e;var t={};t["typeof"]="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},t.classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},t.createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var i=function(){function e(e,t,i,n){return e.filter(function(e){return e&&(!t||e.e===t||e.e.substr(0,e.e.indexOf("."))===t)&&(!i||e.cb===i||e.cb._cb===i)&&(!n||e.ctx===n)})}function t(e,t,i){(e||"").split(u).forEach(function(e){i(e,t)})}function i(e,t){for(var i,n=!1,r=-1,u=e.length;++r<u;)if(i=e[r],i.cb.apply(i.ctx2,t)===!1){n=!0;break}return!n}var n,r=[].slice,u=/\s+/;return n={on:function(e,i,n){var r,u=this;return i?(r=this._events||(this._events=[]),t(e,i,function(e,t){var i={e:e};i.cb=t,i.ctx=n,i.ctx2=n||u,i.id=r.length,r.push(i)}),this):this},once:function(e,i,n){var r=this;return i?(t(e,i,function(e,t){var i=function u(){return r.off(e,u),t.apply(n||r,arguments)};i._cb=t,r.on(e,i,n)}),r):r},off:function(i,n,r){var u=this._events;return u?i||n||r?(t(i,n,function(t,i){e(u,t,i,r).forEach(function(e){delete u[e.id]})}),this):(this._events=[],this):this},trigger:function(t){var n,u,a;return this._events&&t?(n=r.call(arguments,1),u=e(this._events,t),a=e(this._events,"all"),i(u,n)&&i(a,arguments)):this}},Object.assign({installTo:function(e){return Object.assign(e,n)}},n)},n=function(){function i(){t.classCallCheck(this,i),this._regulars={require:/.+/,number:/^[\-+]?(0|[1-9]\d*)(\.\d+)?$/,date:/^(0[1-9]|1[0-2])\/(0[1-9]|1\d|2\d|3[01])\/(10|11|12|13|14|15|16|17|18|19|20)\d{2}$/,email:/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i,url:/^(http|https):\/\/[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@\[\]\':+!]*([^<>\"])*$/,ip:/^(0|[1-9]\d?|[0-1]\d{2}|2[0-4]\d|25[0-5]).(0|[1-9]\d?|[0-1]\d{2}|2[0-4]\d|25[0-5]).(0|[1-9]\d?|[0-1]\d{2}|2[0-4]\d|25[0-5]).(0|[1-9]\d?|[0-1]\d{2}|2[0-4]\d|25[0-5])$/,empty:/^\s*$/,letter:/^[a-zA-Z]{1,}$/,password:/^[a-zA-Z]\w{5,17}$/,trade_password:/^\d{6}$/,mobile:/^(13[0-9]|14[0-9]|15[0-9]|18[0-9])\d{8}$/i,qq:/^[1-9][0-9]{4,}$/}}return t.createClass(i,[{key:"add",value:function(t){return e.extend(this._regulars,t||{}),this}},{key:"regulars",get:function(){return this._regulars}}]),i}(),r=function(){function n(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],r=e.field,u=void 0===r?null:r,a=e.rules,s=void 0===a?null:a,l=e.messages,o=void 0===l?null:l;t.classCallCheck(this,n);var h=new i;return h.installTo(this),this._status=!0,this.$field=u,this.rules=s,this._message=null,this._messages={},this._error=null,this.triggerEvents=[],this.regulars={},this.$xhr=null,this._initMessages(o),this._handleQuery=null,this._handleLoading=null,this._handleShowPopup=null,this._handleHidePopup=null,this.init(),this}return t.createClass(n,[{key:"init",value:function(){this.$popup=e('[aria-popup="'+this.$field.attr("aria-popup-name")+'"]')}},{key:"setRegulars",value:function(e){return this.regulars=e,this}},{key:"setEvents",value:function(e){return this.triggerEvents=e,this}},{key:"setPopup",value:function(e){return this.$popup=e,this}},{key:"setHandleQuery",value:function(e){return this._handleQuery=e,this}},{key:"setHandleShowPopup",value:function(e){return this._handleShowPopup=e,this}},{key:"setHandleHidePopup",value:function(e){return this._handleHidePopup=e,this}},{key:"getQueryData",value:function(){var e={};return"function"==typeof this._handleQuery?e=this._handleQuery():"object"==t["typeof"](this._handleQuery)&&(e=this._handleQuery),e}},{key:"setHandleLoading",value:function(e){return this._handleLoading=e,this}},{key:"setStatus",value:function(e,t){return this._status=e,this._error=e?null:t,null!=this._error?(this._message=void 0==this._messages[this.error]?null:this._messages[this.error],this.showPopup()):(this._message=null,this.hidePopup()),this}},{key:"_initMessages",value:function(t){if(null!=t&&!e.isEmptyObject(t))for(var i in t){var n=i.split(","),r=!0,u=!1,a=void 0;try{for(var s,l=n[Symbol.iterator]();!(r=(s=l.next()).done);r=!0){var o=s.value;this._messages[o]=t[n]}}catch(h){u=!0,a=h}finally{try{!r&&l["return"]&&l["return"]()}finally{if(u)throw a}}}}},{key:"val",value:function(){return this.$field.val()}},{key:"showPopup",value:function(){"function"==typeof this._handleShowPopup?this._handleShowPopup(this,this.message):this.$popup.html(this.message).show(),this.trigger("afterShowPopup",this)}},{key:"hidePopup",value:function(){"function"==typeof this._handleHidePopup?this._handleHidePopup(this):this.$popup.empty().hide(),this.trigger("afterHidePopup",this)}},{key:"validating",value:function(e){null!=this._handleLoading?"function"==typeof this._handleLoading&&(this.hidePopup(),this._handleLoading(e,this)):e?this.$popup.html("loading...").show():this.hidePopup()}},{key:"status",get:function(){return this._status}},{key:"error",get:function(){return this._error}},{key:"message",get:function(){return this._message}}]),n}(),u=function(){function i(){t.classCallCheck(this,i)}return t.createClass(i,[{key:"required",value:function(e){var t=e.$field;return["checkbox","radio"].indexOf(t.attr("type"))>-1?t.is(":checked"):""!=e.val()}},{key:"regular",value:function(e,t,i){var n=e.val(),r=void 0;if(""==n)return!0;if(void 0!=e.regulars[t])r=e.regulars[t];else{if(void 0==i[t])throw new Error("Not Found regulars:"+t);r=i[t]}return r.global&&(r.lastIndex=0),r.test(n)}},{key:"min",value:function(e,t){var i=e.val();return""==i?!0:i.length>=t}},{key:"max",value:function(e,t){var i=e.val();return""==i?!0:i.length<=t}},{key:"remote",value:function(t,i){var n=t.val();if(""==n)return!0;t.validating(!0);var r=i,u={fieldValue:n};return u=e.extend(!0,{},u,t.getQueryData()||{}),t.$xhr=e.ajax({url:r,data:u,type:"get",dataType:"json",success:function(e){t.validating(!1),e.validate?t.setStatus(!0).hidePopup():t.setStatus(!1,"remote").showPopup()}}),"validating"}},{key:"customHandle",value:function(e,t){return t.call(null,e)}},{key:"sameTo",value:function(e,t,i){var n=this._searchFieldBase(i,t);if(void 0!=n)return e.val()==n.val();throw new Error("Not Found regulars:"+t)}},{key:"_searchFieldBase",value:function(e,t){var i=void 0,n=!0,r=!1,u=void 0;try{for(var a,s=e[Symbol.iterator]();!(n=(a=s.next()).done);n=!0){var l=a.value;if(l.$field[0]==t[0]){i=l;break}}}catch(o){r=!0,u=o}finally{try{!n&&s["return"]&&s["return"]()}finally{if(r)throw u}}return i}}]),i}(),a=function(){function a(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],r=e.regulars,s=void 0===r?{}:r,l=e.customFuncs,o=void 0===l?{}:l,h=e.handleShowPopup,d=void 0===h?null:h,f=e.handleHidePopup,c=void 0===f?null:f,v=e.fieldHooks,F=void 0===v?{}:v;t.classCallCheck(this,a),this.$fieldsBase=[];var p=new i;p.installTo(this),this.$regulars=new n,this.$regulars.add(s),this.$customFuns=o,this.handleShowPopup=d,this.handleHidePopup=c,this.fieldHooks=F,this.$validateHandle=new u}return t.createClass(a,[{key:"addField",value:function(t,i,n){var u=this,a=new r({field:t,rules:i,messages:n}).setHandleShowPopup(this.handleShowPopup).setHandleHidePopup(this.handleHidePopup);"function"==typeof this.afterShowPopup&&a.on("afterShowPopup");var s=!0,l=!1,o=void 0;try{for(var h,d=Object.keys(this.fieldHooks)[Symbol.iterator]();!(s=(h=d.next()).done);s=!0){var f=h.value;a.on(f,this.fieldHooks[f])}}catch(c){l=!0,o=c}finally{try{!s&&d["return"]&&d["return"]()}finally{if(l)throw o}}return this.$fieldsBase.push(a),a.triggerEvents.length&&e.each(a.triggerEvents,function(e,t){a.$field.on(t,function(){u.validateField(a)})}),a}},{key:"validateField",value:function(e){if(e.$field.length){var t=!0,i=void 0,n=e.rules;for(var r in n){var u=n[r];if("required"==r){if(t=this.$validateHandle.required(e),!t){i=r;break}}else if("regular"==r){var a=u.split(","),s=!0,l=!1,o=void 0;try{for(var h,d=a[Symbol.iterator]();!(s=(h=d.next()).done);s=!0){var f=h.value;if(t=this.$validateHandle.regular(e,f,this.$regulars.regulars),!t){i=f;break}}}catch(c){l=!0,o=c}finally{try{!s&&d["return"]&&d["return"]()}finally{if(l)throw o}}if(!t)break}else if(0===r.indexOf("custom")){if("string"==typeof u&&"function"==typeof this.$customFuns[u]&&(u=this.$customFuns[u]),t=this.$validateHandle.customHandle(e,u),!t){i=r;break}}else if("sameTo"==r){if(t=this.$validateHandle.sameTo(e,u,this.$fieldsBase),!t){i=r;break}}else{if("remote"==r){t=this.$validateHandle.remote(e,u);break}if("function"==typeof this.$validateHandle[r]&&(t=this.$validateHandle[r](e,u),!t)){i=r;break}}}"validating"!=t&&e.setStatus(t,i)}}},{key:"validateAll",value:function(){var t=!0,i=!1,n=void 0;try{for(var r,u=this.$fieldsBase[Symbol.iterator]();!(t=(r=u.next()).done);t=!0){var a=r.value,s=a.$field;s.context!=s[0]&&""!=s.selected&&(a.$field=e(s.selector,s.context),a.init()),this.validateField(a)}}catch(l){i=!0,n=l}finally{try{!t&&u["return"]&&u["return"]()}finally{if(i)throw n}}}},{key:"submit",value:function(){var t=arguments.length<=0||void 0===arguments[0]?e.noop:arguments[0];this.validateAll();var i=this._getFieldsXHR();i.length>0?e.when.apply({},i).done(function(){this.trigger("afterValidate"),this._hasError()||(t(),this.trigger("submit"))}.bind(this)):(this.trigger("afterValidate"),this._hasError()||(t(),this.trigger("submit")))}},{key:"_getFieldsXHR",value:function(){var e=[],t=!0,i=!1,n=void 0;try{for(var r,u=this.$fieldsBase[Symbol.iterator]();!(t=(r=u.next()).done);t=!0){var a=r.value;null!=a.$xhr&&e.push(a.$xhr)}}catch(s){i=!0,n=s}finally{try{!t&&u["return"]&&u["return"]()}finally{if(i)throw n}}return e}},{key:"_hasError",value:function(){var e=!1,t=!0,i=!1,n=void 0;try{for(var r,u=this.$fieldsBase[Symbol.iterator]();!(t=(r=u.next()).done);t=!0){var a=r.value;if(!a.status){e=!0;break}}}catch(s){i=!0,n=s}finally{try{!t&&u["return"]&&u["return"]()}finally{if(i)throw n}}return e}}]),a}();return a});