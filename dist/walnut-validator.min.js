/*!
 * walnut-validator.js v1.0.0
 * (c) 2016 Cary Xiao
 * Released under the MIT License.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("jquery")):"function"==typeof define&&define.amd?define(["jquery"],t):e.WalnutValidator=t(e.jQuery)}(this,function(e){"use strict";e="default"in e?e["default"]:e;var t={};t["typeof"]="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},t.classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},t.createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var i=function(){function t(t,i,n,u){return e.grep(t,function(e){return e&&(!i||e.e===i||e.e.substr(0,e.e.indexOf("."))===i)&&(!n||e.cb===n||e.cb._cb===n)&&(!u||e.ctx===u)})}function i(t,i,n){e.each((t||"").split(a),function(e,t){n(t,i)})}function n(e,t){for(var i,n=!1,u=-1,r=e.length;++u<r;)if(i=e[u],i.cb.apply(i.ctx2,t)===!1){n=!0;break}return!n}var u,r=[].slice,a=/\s+/;return u={on:function(e,t,n){var u,r=this;return t?(u=this._events||(this._events=[]),i(e,t,function(e,t){var i={e:e};i.cb=t,i.ctx=n,i.ctx2=n||r,i.id=u.length,u.push(i)}),this):this},once:function(e,t,n){var u=this;return t?(i(e,t,function(e,t){var i=function r(){return u.off(e,r),t.apply(n||u,arguments)};i._cb=t,u.on(e,i,n)}),u):u},off:function(n,u,r){var a=this._events;return a?n||u||r?(console.log(a),i(n,u,function(i,n){e.each(t(a,i,n,r),function(){delete a[this.id]})}),this):(this._events=[],this):this},trigger:function(e){var i,u,a;return this._events&&e?(i=r.call(arguments,1),u=t(this._events,e),a=t(this._events,"all"),n(u,i)&&n(a,arguments)):this}},e.extend({installTo:function(t){return e.extend(t,u)}},u)},n=function(){function i(){t.classCallCheck(this,i),this._regulars={require:/.+/,number:/^[\-+]?(0|[1-9]\d*)(\.\d+)?$/,date:/^(0[1-9]|1[0-2])\/(0[1-9]|1\d|2\d|3[01])\/(10|11|12|13|14|15|16|17|18|19|20)\d{2}$/,email:/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i,url:/^(http|https):\/\/[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@\[\]\':+!]*([^<>\"])*$/,ip:/^(0|[1-9]\d?|[0-1]\d{2}|2[0-4]\d|25[0-5]).(0|[1-9]\d?|[0-1]\d{2}|2[0-4]\d|25[0-5]).(0|[1-9]\d?|[0-1]\d{2}|2[0-4]\d|25[0-5]).(0|[1-9]\d?|[0-1]\d{2}|2[0-4]\d|25[0-5])$/,empty:/^\s*$/,letter:/^[a-zA-Z]{1,}$/,password:/^[a-zA-Z]\w{5,17}$/,trade_password:/^\d{6}$/,mobile:/^(13[0-9]|14[0-9]|15[0-9]|18[0-9])\d{8}$/i,qq:/^[1-9][0-9]{4,}$/}}return t.createClass(i,[{key:"add",value:function(t){return e.extend(this._regulars,t||{}),this}},{key:"regulars",get:function(){return this._regulars}}]),i}(),u=function(){function n(){var u=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],r=u.field,a=void 0===r?null:r,s=u.rules,l=void 0===s?null:s,o=u.messages,h=void 0===o?null:o;t.classCallCheck(this,n);var d=new i;return d.installTo(this),this._status=!0,this.$field=a,this.rules=l,this._message=null,this._messages={},this._error=null,this.triggerEvents=[],this.regulars={},this.$xhr=null,this._initMessages(h),this._handleQuery=null,this._handleLoading=null,this._handleShowPopup=null,this._handleHidePopup=null,this.$popup=e('[aria-popup="'+this.$field.attr("aria-popup-name")+'"]'),this}return t.createClass(n,[{key:"setRegulars",value:function(e){return this.regulars=e,this}},{key:"setEvents",value:function(e){return this.triggerEvents=e,this}},{key:"setPopup",value:function(e){return this.$popup=e,this}},{key:"setHandleQuery",value:function(e){return this._handleQuery=e,this}},{key:"setHandleShowPopup",value:function(e){return this._handleShowPopup=e,this}},{key:"setHandleHidePopup",value:function(e){return this._handleHidePopup=e,this}},{key:"getQueryData",value:function(){var e={};return"function"==typeof this._handleQuery?e=this._handleQuery():"object"==t["typeof"](this._handleQuery)&&(e=this._handleQuery),e}},{key:"setHandleLoading",value:function(e){return this._handleLoading=e,this}},{key:"setStatus",value:function(e,t){return this._status=e,this._error=e?null:t,null!=this._error?(this._message=void 0==this._messages[this.error]?null:this._messages[this.error],this.showPopup()):(this._message=null,this.hidePopup()),this}},{key:"_initMessages",value:function(t){null==t||e.isEmptyObject(t)||e.each(t,function(t,i){var n=t.split(",");e.each(n,function(e,t){this._messages[t]=i}.bind(this))}.bind(this))}},{key:"val",value:function(){return this.$field.val()}},{key:"showPopup",value:function(){"function"==typeof this._handleShowPopup?this._handleShowPopup(this,this.message):this.$popup.html(this.message).show(),this.trigger("afterShowPopup",this)}},{key:"hidePopup",value:function(){"function"==typeof this._handleHidePopup?this._handleHidePopup(this):this.$popup.empty().hide(),this.trigger("afterHidePopup",this)}},{key:"validating",value:function(e){null!=this._handleLoading?"function"==typeof this._handleLoading&&(this.hidePopup(),this._handleLoading(e,this)):e?this.$popup.html("loading...").show():this.hidePopup()}},{key:"status",get:function(){return this._status}},{key:"error",get:function(){return this._error}},{key:"message",get:function(){return this._message}}]),n}(),r=function(){function e(){t.classCallCheck(this,e)}return t.createClass(e,[{key:"required",value:function(e){var t=e.$field;return["checkbox","radio"].indexOf(t.attr("type"))>-1?t.is(":checked"):""!=e.val()}},{key:"regular",value:function(e,t,i){var n=e.val(),u=void 0;if(""==n)return!0;if(void 0!=e.regulars[t])u=e.regulars[t];else{if(void 0==i[t])throw new Error("Not Found regulars:"+t);u=i[t]}return u.global&&(u.lastIndex=0),u.test(n)}},{key:"min",value:function(e,t){var i=e.val();return""==i?!0:i.length>=t}},{key:"max",value:function(e,t){var i=e.val();return""==i?!0:i.length<=t}},{key:"remote",value:function(e,t){var i=e.val();if(""==i)return!0;e.validating(!0);var n=t,u={fieldValue:i};return u=$.extend(!0,{},u,e.getQueryData()||{}),e.$xhr=$.ajax({url:n,data:u,type:"get",dataType:"json",success:function(t){e.validating(!1),t.validate?e.setStatus(!0).hidePopup():e.setStatus(!1,"remote").showPopup()}}),"validating"}},{key:"customHandle",value:function(e,t){return t.call(null,e)}},{key:"sameTo",value:function(e,t,i){var n=this._searchFieldBase(i,t);if(void 0!=n)return e.val()==n.val();throw new Error("Not Found regulars:"+t)}},{key:"_searchFieldBase",value:function(e,t){var i=void 0,n=!0,u=!1,r=void 0;try{for(var a,s=e[Symbol.iterator]();!(n=(a=s.next()).done);n=!0){var l=a.value;if(l.$field[0]==t[0]){i=l;break}}}catch(o){u=!0,r=o}finally{try{!n&&s["return"]&&s["return"]()}finally{if(u)throw r}}return i}}]),e}(),a=function(){function e(){var u=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],a=u.regulars,s=void 0===a?{}:a,l=u.customFuncs,o=void 0===l?{}:l,h=u.handleShowPopup,d=void 0===h?null:h,f=u.handleHidePopup,c=void 0===f?null:f,v=u.fieldHooks,F=void 0===v?{}:v;t.classCallCheck(this,e),this.$fieldsBase=[];var p=new i;p.installTo(this),this.$regulars=new n,this.$regulars.add(s),this.$customFuns=o,this.handleShowPopup=d,this.handleHidePopup=c,this.fieldHooks=F,this.$validateHandle=new r}return t.createClass(e,[{key:"addField",value:function(e,t,i){var n=this,r=new u({field:e,rules:t,messages:i}).setHandleShowPopup(this.handleShowPopup).setHandleHidePopup(this.handleHidePopup);"function"==typeof this.afterShowPopup&&r.on("afterShowPopup");var a=!0,s=!1,l=void 0;try{for(var o,h=Object.keys(this.fieldHooks)[Symbol.iterator]();!(a=(o=h.next()).done);a=!0){var d=o.value;r.on(d,this.fieldHooks[d])}}catch(f){s=!0,l=f}finally{try{!a&&h["return"]&&h["return"]()}finally{if(s)throw l}}return this.$fieldsBase.push(r),r.triggerEvents.length&&$.each(r.triggerEvents,function(e,t){r.$field.on(t,function(){n.validateField(r)})}),r}},{key:"validateField",value:function(e){if(e.$field.length){var t=!0,i=void 0,n=e.rules;for(var u in n){var r=n[u];if("required"==u){if(t=this.$validateHandle.required(e),!t){i=u;break}}else if("regular"==u){var a=r.split(","),s=!0,l=!1,o=void 0;try{for(var h,d=a[Symbol.iterator]();!(s=(h=d.next()).done);s=!0){var f=h.value;if(t=this.$validateHandle.regular(e,f,this.$regulars.regulars),!t){i=f;break}}}catch(c){l=!0,o=c}finally{try{!s&&d["return"]&&d["return"]()}finally{if(l)throw o}}if(!t)break}else if(0===u.indexOf("custom")){if("string"==typeof r&&"function"==typeof this.$customFuns[r]&&(r=this.$customFuns[r]),t=this.$validateHandle.customHandle(e,r),!t){i=u;break}}else if("sameTo"==u){if(t=this.$validateHandle.sameTo(e,r,this.$fieldsBase),!t){i=u;break}}else{if("remote"==u){t=this.$validateHandle.remote(e,r);break}if("function"==typeof this.$validateHandle[u]&&(t=this.$validateHandle[u](e,r),!t)){i=u;break}}}"validating"!=t&&e.setStatus(t,i)}}},{key:"validateAll",value:function(){var e=!0,t=!1,i=void 0;try{for(var n,u=this.$fieldsBase[Symbol.iterator]();!(e=(n=u.next()).done);e=!0){var r=n.value,a=r.$field;a.context!=a[0]&&""!=a.selected&&(r.$field=$(a.selector,a.context)),this.validateField(r)}}catch(s){t=!0,i=s}finally{try{!e&&u["return"]&&u["return"]()}finally{if(t)throw i}}}},{key:"submit",value:function(){var e=arguments.length<=0||void 0===arguments[0]?$.noop:arguments[0];this.validateAll();var t=this._getFieldsXHR();t.length>0?$.when.apply({},t).done(function(){this._hasError()||(e(),this.trigger("submit"))}.bind(this)):this._hasError()||(e(),this.trigger("submit"))}},{key:"_getFieldsXHR",value:function(){var e=[],t=!0,i=!1,n=void 0;try{for(var u,r=this.$fieldsBase[Symbol.iterator]();!(t=(u=r.next()).done);t=!0){var a=u.value;null!=a.$xhr&&e.push(a.$xhr)}}catch(s){i=!0,n=s}finally{try{!t&&r["return"]&&r["return"]()}finally{if(i)throw n}}return e}},{key:"_hasError",value:function(){var e=!1,t=!0,i=!1,n=void 0;try{for(var u,r=this.$fieldsBase[Symbol.iterator]();!(t=(u=r.next()).done);t=!0){var a=u.value;if(!a.status){e=!0;break}}}catch(s){i=!0,n=s}finally{try{!t&&r["return"]&&r["return"]()}finally{if(i)throw n}}return e}}]),e}();return a});